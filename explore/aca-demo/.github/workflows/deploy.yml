name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'infra/app/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      ACR_NAME: ${{ secrets.ACR_NAME }}
      ENVIRONMENT_ID: ${{ secrets.ACA_ENVIRONMENT_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR Credentials
        id: acr_creds
        run: |
          echo "Retrieving credentials for $ACR_NAME..."
          USERNAME=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query username -o tsv)
          PASSWORD=$(az acr credential show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "passwords[0].value" -o tsv)
          LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query loginServer -o tsv)
          
          echo "::add-mask::$PASSWORD"
          echo "registry_username=$USERNAME" >> $GITHUB_OUTPUT
          echo "registry_password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "registry_server=$LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Build and Push Image to ACR
        run: |
          IMAGE_TAG=${{ github.sha }}
          FULL_IMAGE_NAME="${{ steps.acr_creds.outputs.registry_server }}/hello-world:$IMAGE_TAG"
          
          echo "Building and pushing $FULL_IMAGE_NAME..."
          az acr build --registry ${{ env.ACR_NAME }} --image hello-world:$IMAGE_TAG --resource-group ${{ env.RESOURCE_GROUP }} ./src

      - name: Deploy Container App
        uses: azure/arm-deploy@v1
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.RESOURCE_GROUP }}
          template: infra/app/main.bicep
          parameters: >
            environmentId=${{ env.ENVIRONMENT_ID }}
            containerImage=${{ steps.acr_creds.outputs.registry_server }}/hello-world:${{ github.sha }}
            registryServer=${{ steps.acr_creds.outputs.registry_server }}
            registryUsername=${{ steps.acr_creds.outputs.registry_username }}
            registryPassword=${{ steps.acr_creds.outputs.registry_password }}
